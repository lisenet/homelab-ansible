{{ ansible_managed | comment }}
# Generated by Ansible role {{ ansible_role_name }}
# As of 2.0.0, HAProxy includes a Prometheus exporter module.
# Rocky 8 comes with HAProxy 1.8. Remove this exporter
# configuration when migrating to Rocky 9 and HAProxy 2.4.

[Unit]
Description=Prometheus
Documentation=https://github.com/prometheus/haproxy_exporter
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User={{ prometheus_user }}
Group={{ prometheus_user }}
ExecReload=/bin/kill -HUP $MAINPID
ExecStart=/usr/local/bin/{{ haproxy_exporter_binary }} \
  --haproxy.pid-file=/var/run/haproxy.pid \
  --haproxy.timeout=20s \
  --web.listen-address=0.0.0.0:{{ haproxy_exporter_port }} \
  --web.telemetry-path=/metrics \
  --no-haproxy.ssl-verify \
  '--haproxy.scrape-uri=https://{{ haproxy_stats_user }}:{{ haproxy_stats_password }}@127.0.0.1:{{ haproxy_stats_port }}/stats;csv'

SyslogIdentifier=prometheus
Restart=always

[Install]
WantedBy=multi-user.target
