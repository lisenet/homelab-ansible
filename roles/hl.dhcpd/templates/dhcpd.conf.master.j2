{{ ansible_managed | comment }}
# Generated by Ansible role {{ ansible_role_name }}

failover peer "failover-dhcp" {
  primary; # This defines the master
  address {{ bind_master_server_address }};
  port {{ firewall_dhcp_failover_port }};
  peer address {{ bind_slave_server_address }};
  peer port {{ firewall_dhcp_failover_port }};
  max-response-delay 60;
  max-unacked-updates 10;
  mclt 3600;
  split 128; # 128 is balanced; use 255 if primary is 100% responsible until failure
  load balance max seconds 3;
}

authoritative;
allow booting;
allow bootp;
next-server {{ tftp_next_server }}; # TFTP
filename "pxelinux.0";
default-lease-time 86400; # 1 day
max-lease-time 86400; # 1 day

ddns-update-style interim;

update-static-leases on;
one-lease-per-client on;

# We generated the rndc-key when setting up DNS servers
key "rndc-key" {
  algorithm hmac-sha256;
  secret "{{ rndc_key }}";
};

# We created zones when setting up DNS servers
zone {{ homelab_reverse_zone }}.in-addr.arpa {
  primary {{ bind_master_server_address }};
  key "rndc-key";  
}
zone {{ homelab_domain_name }} {
  primary {{ bind_master_server_address }};
  key "rndc-key";
}

subnet {{ homelab_address }} netmask {{ homelab_subnet_mask }} {
  option subnet-mask {{ homelab_subnet_mask }};
  option broadcast-address {{ homelab_broadcast }};
  option routers {{ homelab_gateway }};
  option domain-name-servers dns1.hl.test, dns2.hl.test;
  option domain-search "{{ homelab_domain_name }}";
  pool {
    failover peer "failover-dhcp";
    range {{ dhcp_address_range_start }} {{ dhcp_address_range_end }};
  }
}

# Physical hosts range: 10.11.1.4-10.11.1.29
{% for item in dhcp_leases_for_physical_hosts %}
host {{ item.host_name }} {
  hardware ethernet {{ item.mac_address }};
  fixed-address {{ item.ip_address }};
  option host-name {{ item.host_name }};
}
{% endfor %}

# Virtual hosts range: 10.11.1.30-10.11.1.49
# Below are DHCP leases for PXE boot
{% for item in dhcp_leases_for_virtual_hosts %}
host {{ item.host_name }} {
  hardware ethernet {{ item.mac_address }};
  fixed-address {{ item.ip_address }};
  option host-name {{ item.host_name }};
}
{% endfor %}

# MetalLB range: 10.11.1.51-10.11.1.59
